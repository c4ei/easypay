<!DOCTYPE html>
<html lang="en">
  <head>
      <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
      <meta name="description" content="" />
      <meta name="author" content="" />
      <title>c4ei</title>
      <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
  </head>
  <body >
    <h4 id="ly_dispmsg" style="color: bisque;font-size: 12px;">메타마스크 연동 후 mining이 가능 합니다.</h4>
    <button class="enableEthereumButton">conncet Metamask</button>
    <span class="showAccount" style="font-size: 8px;"></span><br/>
    <input type="button" value="let`s go mining!" id="btn_mining_start" onclick='jsfn_goto_mining();' style="visibility: hidden;width:160px;height:30px;background-color: cornflowerblue;" >

    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>
    <script>
      const btnMetaMask = document.querySelector('.enableEthereumButton');
      const showAccount = document.querySelector('.showAccount');
      btnMetaMask.addEventListener('click', () => { jsfn_getAccount(); });

      async function jsfn_getAccount() {
        const web3 = new Web3(window.ethereum);
        if (typeof web3 === 'undefined' || !web3.currentProvider?.isMetaMask) {
          console.log('MetaMask is not enabled');
          this.error = 'MetaMask is not enabled';
          await this.render();
          return;
        }
        
        await window.ethereum.enable();
        await window.ethereum.request({ method: 'eth_requestAccounts' });

        const networkData = [
          {
            chainId: '0x520C', // chain id in hexidecimal
            chainName: 'C4EI',
            rpcUrls: ['https://rpc.c4ei.net/'], // dependent on main vs. testnet
        
            nativeCurrency: {
              name: 'C4EI',
              symbol: 'C4EI',
              decimals: 18
            },
        
            blockExplorerUrls: ['https://exp.c4ei.net/'] // dependent on main vs. testnet
          }
        ];      
        const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
        const account = accounts[0];
        showAccount.innerHTML = "address:"+account;
        // console.log(account +": account line 106");
        btnMetaMask.style.display='none';
        jsfn_bindAddress(account);
        // alert(account+":account");
      }
      function jsfn_bindAddress(addr){
        // document.getElementById('ly_userAccount').innerText = addr;
        if (addr!==undefined){
            jsfn_btnShowHide('visible');
            jsfn_chkAddress(addr);
        } else {
            jsfn_btnShowHide('hidden');
        }
    }
    function jsfn_btnShowHide(str){
        // let _btn = document.getElementById('btn_mining_start');
        let _msg = document.getElementById('ly_dispmsg');
        // _btn.style.visibility = str;
        if(str == 'visible'){ _msg.style.display = 'none'; } else { _msg.style.display = 'block'; }
    }
    function jsfn_chkAddress(addr){
        document.getElementById('txt_my_address').value = addr;
        document.getElementById('btn_mining_start').style.visibility = 'visible';
    }
    function jsfn_goto_mining(){
        let chkAddr = document.getElementById('txt_my_address').value;
        if(chkAddr!=''){
            document.sendForm.submit();
        }
    }
    </script>
    <script> 
      function jsfn_sendPost(url, params) { 
        var form = document.createElement('form'); 
        form.setAttribute('method', 'post'); 
        form.setAttribute('target', '_blank'); 
        form.setAttribute('action', url); 
        document.charset = "UTF-8"; 
        for (var key in params) { 
          var hiddenField = document.createElement('input'); 
          hiddenField.setAttribute('type', 'hidden'); 
          hiddenField.setAttribute('name', key); 
          hiddenField.setAttribute('value', params[key]); 
          form.appendChild(hiddenField);
        }
        document.body.appendChild(form); 
        form.submit(); 
      }
    </script>

    <div id="htmlForm" style="display: block;">
      <form id="sendForm" name="sendForm" method="post" action="/game">
        <input type="hidden"  id="txt_my_address" name="txt_my_address" value="" >
      </form>
    </div>
  </body>
</html>
